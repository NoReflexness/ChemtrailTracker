<!DOCTYPE html>
<html>

<head>
    <title>Flight Tracker Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>

<body>
    <div class="dashboard">
        <!-- Top Bar: Stats -->
        <header class="top-bar">
            <h1>Flight Tracker</h1>
            <div class="stats">
                <span>Tracked Flights: <span id="flight-count">0</span></span>
                <span>Active Areas: <span id="area-count">0</span></span>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left: Map -->
            <div class="map-container">
                <div id="map"></div>
                <div class="legend">
                    <div><span style="color: #808080;">⋯</span> Monitored Area</div>
                    <div><span style="color: #00ff00;">■</span> A-to-B</div>
                    <div><span style="color: #ff0000;">■</span> Survey</div>
                    <div><span style="color: #808080;">■</span> Other</div>
                </div>
            </div>

            <!-- Right: Controls and Flight List -->
            <aside class="sidebar">
                <div class="controls">
                    <h2>Controls</h2>
                    <select id="frequency">
                        <option value="30s">30s</option>
                        <option value="1m">1m</option>
                        <option value="5m">5m</option>
                    </select>
                    <button onclick="startMonitoring()">Start Monitoring</button>
                    <button id="retrain-btn" onclick="retrainModel()" disabled>Retrain Model</button>
                </div>
                <div class="flight-list">
                    <h2>Active Flights</h2>
                    <div id="flight-list-content"></div>
                </div>
            </aside>
        </div>

        <!-- Bottom: Logs -->
        <footer class="log-container">
            <h2>Logs</h2>
            <pre id="log"></pre>
        </footer>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="/static/map.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>
    <script>
        const socket = io();
        let areas = [];
        let currentArea = null;
        const flightLines = {};
        const flightLayer = L.layerGroup();
        let canRetrain = false;

        socket.on('log', (data) => {
            const log = document.getElementById('log');
            log.innerText += data.message + '\n';
            log.scrollTop = log.scrollHeight;
        });

        socket.on('flight_update', (flight) => {
            const coords = flight.points.map(p => [p[0], p[1]]);
            if (flightLines[flight.flight_id]) {
                flightLayer.removeLayer(flightLines[flight.flight_id]);
            }
            const color = flight.classification === 'survey' ? '#ff0000' :
                flight.classification === 'a_to_b' ? '#00ff00' : '#808080';
            if (coords.length > 1) {
                flightLines[flight.flight_id] = L.polyline(coords, { color: color, weight: 4 });
                flightLines[flight.flight_id].bindPopup(`Flight: ${flight.flight_id}<br>Class: ${flight.classification || 'N/A'} (${flight.classification_source || 'N/A'})`);
                flightLines[flight.flight_id].addTo(flightLayer);
            } else {
                flightLines[flight.flight_id] = L.marker(coords[0], { color: color });
                flightLines[flight.flight_id].bindPopup(`Flight: ${flight.flight_id}<br>Class: ${flight.classification || 'N/A'} (${flight.classification_source || 'N/A'})`);
                flightLines[flight.flight_id].addTo(flightLayer);
            }
            updateFlightList();
            updateStats();
        });

        const map = L.map('map').setView([56.0, 11.0], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);
        flightLayer.addTo(map);

        map.on('click', (e) => {
            if (e.originalEvent.shiftKey) {
                if (!currentArea) {
                    currentArea = { start: e.latlng };
                } else {
                    const bounds = L.latLngBounds(currentArea.start, e.latlng);
                    addArea(bounds);
                    currentArea = null;
                }
            }
        });

        function addArea(bounds) {
            // Remove overlapping areas
            areas = areas.filter(area => !bounds.intersects(area.rectangle.getBounds()));
            areas.forEach(area => map.removeLayer(area.rectangle));

            const rectangle = L.rectangle(bounds, {
                color: '#808080',
                weight: 2,
                dashArray: '5, 5',
                fillOpacity: 0
            }).addTo(map);
            areas.push({ rectangle, bounds });
            updateStats();
        }

        function updateFlightPaths() {
            fetch('/flight_paths')
                .then(response => response.json())
                .then(data => {
                    const activeFlightIds = new Set(data.map(f => f.flight_id));
                    // Remove stale flights
                    Object.keys(flightLines).forEach(id => {
                        if (!activeFlightIds.has(id)) {
                            flightLayer.removeLayer(flightLines[id]);
                            delete flightLines[id];
                        }
                    });
                    // Update or add flights
                    data.forEach(flight => {
                        const coords = flight.points.map(p => [p[0], p[1]]);
                        if (flightLines[flight.flight_id]) {
                            flightLayer.removeLayer(flightLines[flight.flight_id]);
                        }
                        const color = flight.classification === 'survey' ? '#ff0000' :
                            flight.classification === 'a_to_b' ? '#00ff00' : '#808080';
                        if (coords.length > 1) {
                            flightLines[flight.flight_id] = L.polyline(coords, { color: color, weight: 4 });
                            flightLines[flight.flight_id].bindPopup(`Flight: ${flight.flight_id}<br>Class: ${flight.classification || 'N/A'} (${flight.classification_source || 'N/A'})`);
                            flightLines[flight.flight_id].addTo(flightLayer);
                        } else {
                            flightLines[flight.flight_id] = L.marker(coords[0], { color: color });
                            flightLines[flight.flight_id].bindPopup(`Flight: ${flight.flight_id}<br>Class: ${flight.classification || 'N/A'} (${flight.classification_source || 'N/A'})`);
                            flightLines[flight.flight_id].addTo(flightLayer);
                        }
                    });
                    updateFlightList();
                    updateStats();
                    // Check if retrain is viable
                    fetch('/flight_paths').then(r => r.json()).then(data => {
                        const classCounts = data.reduce((acc, f) => {
                            acc[f.classification] = (acc[f.classification] || 0) + 1;
                            return acc;
                        }, {});
                        canRetrain = Object.keys(classCounts).length > 1 && data.length >= 10;
                        document.getElementById('retrain-btn').disabled = !canRetrain;
                    });
                })
                .catch(error => console.error('Error fetching paths:', error));
        }

        function updateFlightList() {
            const list = document.getElementById('flight-list-content');
            list.innerHTML = '';
            Object.keys(flightLines).forEach(id => {
                const flight = flightLines[id];
                const points = flight.getLatLngs ? flight.getLatLngs().length : 1;
                const popupContent = flight.options.popupContent || '';
                const currentClass = popupContent.match(/Class: (.*?)(?:\s\(|$)/)?.[1] || 'N/A';
                const source = popupContent.match(/\((.*?)\)/)?.[1] || 'N/A';
                const div = document.createElement('div');
                div.innerHTML = `
                    ${id} - Points: ${points} - 
                    <select onchange="updateClassification('${id}', this.value)">
                        <option value="a_to_b" ${currentClass === 'a_to_b' ? 'selected' : ''}>A-to-B</option>
                        <option value="survey" ${currentClass === 'survey' ? 'selected' : ''}>Survey</option>
                        <option value="other" ${currentClass === 'other' ? 'selected' : ''}>Other</option>
                    </select> (${source})
                `;
                list.appendChild(div);
            });
        }

        function updateStats() {
            document.getElementById('flight-count').innerText = Object.keys(flightLines).length;
            document.getElementById('area-count').innerText = areas.length;
        }

        function updateClassification(flightId, classification) {
            fetch('/update_classification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ flight_id: flightId, classification: classification })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error(data.error);
                    } else {
                        document.getElementById('log').innerText += `${data.message}\n`;
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function retrainModel() {
            if (!canRetrain) return;
            fetch('/retrain_model', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error(data.error);
                        document.getElementById('log').innerText += `Error: ${data.error}\n`;
                    } else {
                        document.getElementById('log').innerText += `${data.message}\n`;
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function startMonitoring() {
            if (areas.length === 0) {
                alert("Please shift-click on the map to define at least one monitoring area!");
                return;
            }
            const frequency = document.getElementById('frequency').value;
            areas.forEach(area => {
                const bounds = area.bounds;
                fetch('/start_monitoring', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lamin: bounds.getSouth(),
                        lamax: bounds.getNorth(),
                        lomin: bounds.getWest(),
                        lomax: bounds.getEast(),
                        frequency: frequency
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error(data.error);
                        } else {
                            document.getElementById('log').innerText += 'Monitoring started for area ' + data.area_id + '\n';
                        }
                    })
                    .catch(error => console.error('Error:', error));
            });
        }

        updateFlightPaths();
        setInterval(updateFlightPaths, 10000);
    </script>
</body>

</html>